#!/bin/sh

libpath=/usr/local/lib/rprtgen # расположение. по которому лежат все вспомогательные файлы, включая директорию MIREAcsv

make_title() { # создаётся титульник из titlestub.tex (зависит от стиля mirea.sty). "Слои" - это заполненные поля
	here="$(pwd)"
	cd "${libpath}"
	grep -r "$(sed -n '4p' < "$1")" "./MIREAcsv" | "${libpath}/teachers.sed" > "${q}/layer3"# поиск преподавателя в директориях институтов и списках кафедр
												# результатом становится заполненные поля "Институт", "Кафедра", и "Принял": должность кафедры Фамилия И.О.
	cd "${here}" 
	"${libpath}/subjects.sed" < "$1" > "${q}/layer2" # подмена сокращенного названия предмета полным на основании правил, прописанных в subjects.sed
	paste -d ' ' "${libpath}/titlestub.tex" "${q}/layer2" "${q}/layer3" > "$1" # сборка в файл титульника
}

make_tex() {
	cp "$1" "$q" # копирование файла во временную директорию
	csplit -s "$q/$1" 5 -f "${q}/mireareport" # разбиение копии во временной директории на первые четыре строки (5=4-1) 
						  # - "заголовок" и оставшееся тело документа в формате LaTeX
	make_title "$q/mireareport00" # превращение "заголовка" из четырех строк в полноценный титульник. Тут же открывается весь документ \begin{document}
	echo '\end{document}' >> "${q}/mireareport01" # всякий документ должен быть закончен
	cat "$q/mireareport00" "${q}/mireareport01" > "${outname}.tex" # обратное объединение титульника с основным телом документа
}

make_pdf() {
	xelatex "${outname}.tex"  # считается, что трёх сборок LaTeX достаточно для 99% практически полезных документов 
	xelatex "${outname}.tex"  # (не искусственных примеров, придуманных специально чтобы их LaTeX собирал больше 3 раз)
	xelatex "${outname}.tex"
}

if [ $# -lt 2 ]
then
	echo 'Неверное количество аргументов. Требуется два аргумента: имя исходного файла и имя выходного pdf-файла (без расширения .pdf)' >&2
	exit 1
else
	outname="$2"
	q=/tmp/rprt # имя временной папки. Создаётся прежде всего для верстки титульника
	mkdir "${q}" 
	cp -t $(pwd) "${libpath}/mirea.sty" "${libpath}/MIREAquila.png" # копирование необходимого стиля и герба МИРЭА (второе необходимо для титульника)
	make_tex "$1"
	make_pdf
	rm -rf "${q}" $(ls ${libpath} | grep -v ^d) "${outname}.tex" "${outname}.aux" "${outname}.toc" "mirea.sty" "MIREAquila.png" "${outname}.log" # чистка временных файлов, включая логи
fi
